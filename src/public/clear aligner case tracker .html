<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Clear Aligner Case Tracker Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
      overflow: hidden;
    }

    .login-box {
      background: white;
      padding: 40px 30px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-box h2 {
      margin-bottom: 20px;
      color: #1e40af;
      font-weight: bold;
    }

    .input-container {
      position: relative;
      margin-bottom: 15px;
    }

    .input-container input {
      width: 100%;
      padding: 12px 40px 12px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .input-container input:focus {
      border-color: #1e40af;
      box-shadow: 0 0 5px rgba(30, 64, 175, 0.3);
    }

    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #1e40af;
      font-size: 1rem;
    }

    .login-box button {
      width: 100%;
      padding: 12px;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      margin-top: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    .login-box button:hover:not(:disabled) {
      background: #1e3a8a;
    }

    .login-box button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .message {
      margin-top: 15px;
      font-weight: 600;
      padding: 10px;
      border-radius: 8px;
      display: none;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .debug-info {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
      font-size: 0.9rem;
      display: none;
    }

    .debug-toggle {
      color: #6b7280;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }

    .links {
      margin-top: 20px;
    }

    .links a {
      text-decoration: none;
      color: #1e40af;
      font-weight: 600;
    }

    .links a:hover {
      text-decoration: underline;
    }

    /* Mobile optimization */
    @media (max-width: 500px) {
      .login-box {
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="login-box">
    <h2><i class="fas fa-user-md"></i> Dr. Login</h2>

    <div class="input-container">
      <input type="text" id="username" placeholder="Username" required />
    </div>

    <div class="input-container">
      <input type="password" id="password" placeholder="Password" required />
      <i class="fas fa-eye toggle-password" id="togglePassword"></i>
    </div>

    <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>

    <div class="message" id="message"></div>

    <!-- Demo credentials for testing -->
    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
      <strong>Demo:</strong> demo / demo123
    </div>

    <div class="debug-info" id="debugInfo">
      <strong>Debug Information:</strong>
      <div id="debugDetails"></div>
    </div>

    <div class="debug-toggle" id="debugToggle">
      <i class="fas fa-bug"></i> Show Debug Info
    </div>

    <div class="links">
      <a href="#" onclick="testBackendConnection()">Test Backend Connection</a> |
      <a href="register.html">Register New Patient</a> |
      <a href="index.html">Dashboard</a>
    </div>
  </div>

  <script>
  // Try different possible backend URLs
  const POSSIBLE_BACKEND_URLS = [
    "https://clear-aligner-case-tracker.onrender.com",
    "http://localhost:3000",
    "https://your-backend-domain.com"
  ];

  let BACKEND_URL = POSSIBLE_BACKEND_URLS[0];

  // Show/Hide password toggle
  const passwordField = document.getElementById("password");
  const togglePassword = document.getElementById("togglePassword");

  togglePassword.addEventListener("click", () => {
    const type = passwordField.getAttribute("type") === "password" ? "text" : "password";
    passwordField.setAttribute("type", type);
    togglePassword.classList.toggle("fa-eye-slash");
  });

  // Debug toggle
  document.getElementById('debugToggle').addEventListener('click', function() {
    const debugInfo = document.getElementById('debugInfo');
    debugInfo.style.display = debugInfo.style.display === 'block' ? 'none' : 'block';
    this.innerHTML = debugInfo.style.display === 'block' ? 
      '<i class="fas fa-bug"></i> Hide Debug Info' : 
      '<i class="fas fa-bug"></i> Show Debug Info';
  });

  // Test backend connection
  async function testBackendConnection() {
    const messageEl = document.getElementById('message');
    const debugDetails = document.getElementById('debugDetails');
    
    messageEl.style.display = 'none';
    showMessage('üîç Testing backend connections...', 'info');

    let workingUrl = null;
    
    for (const url of POSSIBLE_BACKEND_URLS) {
      try {
        debugDetails.innerHTML += `Testing: ${url}<br>`;
        const response = await fetch(`${url}/api/auth/login`, {
          method: 'OPTIONS', // Use OPTIONS to avoid actual login
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok || response.status !== 404) {
          workingUrl = url;
          debugDetails.innerHTML += `‚úÖ ${url} is reachable<br>`;
          break;
        }
      } catch (error) {
        debugDetails.innerHTML += `‚ùå ${url} failed: ${error.message}<br>`;
      }
    }

    if (workingUrl) {
      BACKEND_URL = workingUrl;
      showMessage(`‚úÖ Backend found at: ${workingUrl}`, 'success');
    } else {
      showMessage('‚ùå No backend server found. Using demo mode.', 'error');
      debugDetails.innerHTML += 'Switching to demo mode for testing.<br>';
    }
    
    document.getElementById('debugInfo').style.display = 'block';
  }

  // Login handler with better error handling
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const username = document.getElementById("username").value.trim();
    const password = passwordField.value.trim();
    const messageEl = document.getElementById("message");
    const btn = document.getElementById("loginBtn");
    const debugDetails = document.getElementById("debugDetails");

    // Reset message and set loading state
    messageEl.style.display = "none";
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';

    if (!username || !password) {
      showMessage("‚ö†Ô∏è Please enter both username and password.", "error");
      resetButton(btn);
      return;
    }

    // Demo login for testing
    if (username === "demo" && password === "demo123") {
      setTimeout(() => {
        showMessage("‚úÖ Demo login successful! Redirecting...", "success");
        localStorage.setItem("authToken", "demo-token");
        localStorage.setItem("demoMode", "true");
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1500);
      }, 1000);
      return;
    }

    try {
      debugDetails.innerHTML = `Sending request to: ${BACKEND_URL}/api/auth/login<br>`;
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

      const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ username, password }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      debugDetails.innerHTML += `Response status: ${response.status}<br>`;
      
      let data = {};
      try {
        const text = await response.text();
        debugDetails.innerHTML += `Response: ${text}<br>`;
        if (text) {
          data = JSON.parse(text);
        }
      } catch (parseError) {
        debugDetails.innerHTML += `Parse error: ${parseError.message}<br>`;
      }

      if (response.ok) {
        showMessage("‚úÖ Login successful! Redirecting...", "success");
        localStorage.setItem("authToken", data.token);
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1500);
      } else {
        showMessage(`‚ùå ${data.error || data.message || "Login failed. Please try again."}`, "error");
        resetButton(btn);
      }
    } catch (error) {
      console.error("Network error:", error);
      debugDetails.innerHTML += `Error: ${error.message}<br>`;
      
      if (error.name === 'AbortError') {
        showMessage("‚ùå Request timeout. Server is not responding.", "error");
      } else {
        showMessage("‚ùå Cannot connect to server. Please check:\n‚Ä¢ Internet connection\n‚Ä¢ Backend server status\n‚Ä¢ CORS configuration", "error");
      }
      resetButton(btn);
    }
  });

  // Helper functions
  function showMessage(message, type) {
    const messageEl = document.getElementById("message");
    messageEl.textContent = message;
    messageEl.className = `message ${type}`;
    messageEl.style.display = "block";
    
    // Also update debug info
    const debugDetails = document.getElementById("debugDetails");
    debugDetails.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
  }

  function resetButton(btn) {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
  }

  document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      document.getElementById('loginBtn').click();
    }
  });

  // Auto-test backend on load
  window.addEventListener('load', function() {
    setTimeout(testBackendConnection, 500);
  });
  
  </script>
</body>
</html>